<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OS Tracker</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        function getOSInfo() {
            let userAgent = navigator.userAgent;
            let os = "Unknown";
            let osVersion = "Unknown";
            let deviceID = userAgent; // Use User-Agent as a unique identifier

            if (/Windows NT ([\d.]+)/.test(userAgent)) {
                os = "Windows";
                osVersion = RegExp.$1;
            } else if (/Mac OS X ([\d_]+)/.test(userAgent)) {
                os = "MacOS";
                osVersion = RegExp.$1.replace(/_/g, '.');
            } else if (/Android ([\d.]+)/.test(userAgent)) {
                os = "Android";
                osVersion = RegExp.$1;
            } else if (/CPU iPhone OS ([\d_]+)/.test(userAgent)) {
                os = "iOS";
                osVersion = RegExp.$1.replace(/_/g, '.');
            }

            return { os, osVersion, deviceID };
        }

        function handleGoogleLogin(response) {
            const userData = JSON.parse(atob(response.credential.split('.')[1]));
            document.getElementById("userInfo").innerText = `User: ${userData.name}\nEmail: ${userData.email}`;
        }

        function saveDeviceName() {
            let deviceName = document.getElementById("deviceName").value;
            localStorage.setItem("deviceName", deviceName);
        }

        function loadDeviceName() {
            let storedName = localStorage.getItem("deviceName");
            if (storedName) {
                document.getElementById("deviceName").value = storedName;
            }
        }

     async function sendOSInfo() {
    let data = getOSInfo();
    let assetID = document.getElementById("deviceName").value.trim(); 
  

    if (!assetID) assetID = "Unknown";  
   

    let statusElement = document.getElementById("statusMessage");
    statusElement.innerText = "Sending OS info...";
    statusElement.style.color = "blue";

    localStorage.setItem("deviceName", assetID); // Save locally

    console.log("Detected OS:", data);
    console.log("Asset ID:", assetID);  // Debugging
 

    try {
        let response = await fetch("https://script.google.com/macros/s/AKfycbzrgSwD__hZwEMZ_RkEvcYPaCRqpO4dAs_KXzdqsQGa0Vwkx-A1jmCFy2RQR8j0eLY/exec", {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                os: data.os, 
                osVersion: data.osVersion, 
                deviceID: data.deviceID,
                assetID: assetID, // Corrected field name
               
            })
        });

        statusElement.innerText = "Done! OS info sent successfully.";
        statusElement.style.color = "green";
    } catch (error) {
        statusElement.innerText = `Error: ${error.message}`;
        statusElement.style.color = "red";
    }
}

        window.onload = () => {
            let data = getOSInfo();
            document.getElementById("osInfo").innerText = `OS: ${data.os} ${data.osVersion}`;
            loadDeviceName();
        }
    </script>
</head>
<body>
<a href="records.html"><button>View Device Records</button></a>

    <h1>OS Tracker</h1>
    <p id="osInfo">Detecting OS...</p>
    <label for="deviceName">Asset id:</label>
    <input type="text" id="deviceName" placeholder="Enter device name" oninput="saveDeviceName()">
    <p id="statusMessage"></p>
    <div id="g_id_onload"
         data-client_id="YOUR_GOOGLE_CLIENT_ID"
         data-callback="handleGoogleLogin"
         data-auto_prompt="false">
    </div>

    <button onclick="sendOSInfo()">Send OS Info</button>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js');
        }
    </script>
</body>
</html>
